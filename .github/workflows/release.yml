name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bundles: appimage,deb
            archive: linux

          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: msi
            archive: windows

          # Build both mac architectures using the corresponding runner architecture
          - name: macos-aarch64
            os: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg
            archive: macos

          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
            bundles: dmg
            archive: macos

    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: UI deps
        shell: bash
        run: npm --prefix ui ci

      - name: UI build
        shell: bash
        run: npm --prefix ui run build

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Verify tag matches Cargo.toml version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CRATE_VERSION="$(cargo pkgid | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n1)"
          if [[ "${TAG_VERSION}" != "${CRATE_VERSION}" ]]; then
            echo "ERROR: tag version (${TAG_VERSION}) does not match Cargo.toml version (${CRATE_VERSION})" >&2
            exit 1
          fi

      - name: Ensure Cargo.lock is up to date
        shell: bash
        run: |
          set -euo pipefail
          cargo generate-lockfile
          git diff --exit-code -- Cargo.lock

      - name: Load app metadata
        shell: bash
        run: |
          set -euo pipefail
          source scripts/app-config.sh
          echo "APP_NAME=${APP_DISPLAY_NAME}" >> "$GITHUB_ENV"
          echo "BUNDLE_ID=${APP_BUNDLE_ID}" >> "$GITHUB_ENV"
          echo "DMG_VOLUME_NAME=${APP_DMG_VOLUME_NAME}" >> "$GITHUB_ENV"
          echo "WINDOWS_PRODUCT_NAME=${APP_WINDOWS_PRODUCT_NAME}" >> "$GITHUB_ENV"

      - name: Install Linux deps (Tauri)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install tauri-cli
        shell: bash
        run: cargo install tauri-cli --version 2.9.5 --locked

      - name: Build bundles
        shell: bash
        env:
          BETFAIR_APP_KEY: ${{ secrets.BETFAIR_APP_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${BETFAIR_APP_KEY:-}" ]]; then
            echo "ERROR: BETFAIR_APP_KEY secret is missing/empty; release bundles must embed the AppKey." >&2
            exit 1
          fi
          VERSION="${GITHUB_REF_NAME#v}"
          # Keep artifacts contained under target/ for predictable paths.
          export CARGO_TARGET_DIR="target"
          export TAURI_SKIP_UI_BUILD="1"
          cargo tauri build --target "${{ matrix.target }}" --bundles "${{ matrix.bundles }}"

          mkdir -p dist
          PKG_BASE="$(echo "${APP_NAME}" | tr ' ' '-' | tr -cd 'A-Za-z0-9._-')"

          # Collect bundler outputs and rename into stable artifact names.
          BUNDLE_DIR=""
          for candidate in \
            "target/${{ matrix.target }}/release/bundle" \
            "target/release/bundle"; do
            if [[ -d "$candidate" ]]; then
              BUNDLE_DIR="$candidate"
              break
            fi
          done

          if [[ -z "$BUNDLE_DIR" ]]; then
            echo "ERROR: bundle directory not found (bundling may have been skipped)" >&2
            echo "Expected one of:" >&2
            echo "  - target/${{ matrix.target }}/release/bundle" >&2
            echo "  - target/release/bundle" >&2
            echo "Listing target/${{ matrix.target }}/release (if it exists):" >&2
            if [[ -d "target/${{ matrix.target }}/release" ]]; then
              find "target/${{ matrix.target }}/release" -maxdepth 3 -type f -print >&2
            else
              echo "(missing directory)" >&2
            fi
            echo "Listing target/release (if it exists):" >&2
            if [[ -d "target/release" ]]; then
              find "target/release" -maxdepth 3 -type f -print >&2
            else
              echo "(missing directory)" >&2
            fi
            exit 1
          fi

          found_any="0"
          while IFS= read -r -d '' f; do
            ext=""
            case "$f" in
              *.dmg) ext="dmg" ;;
              *.msi) ext="msi" ;;
              *.deb) ext="deb" ;;
              *.AppImage) ext="AppImage" ;;
              *) continue ;;
            esac

            found_any="1"
            out="dist/${PKG_BASE}-${{ matrix.target }}-${VERSION}.${ext}"
            cp -f "$f" "$out"
          done < <(find "$BUNDLE_DIR" -type f -print0)

          if [[ "$found_any" != "1" ]]; then
            echo "ERROR: No bundle artifacts found under ${BUNDLE_DIR}" >&2
            echo "Listing bundle directory (if it exists):" >&2
            if [[ -d "$BUNDLE_DIR" ]]; then
              find "$BUNDLE_DIR" -maxdepth 5 -type f -print >&2
            else
              echo "(missing directory)" >&2
            fi
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            dist/*

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
            dist/**/*.msi
            dist/**/*.dmg
            dist/**/*.AppImage
            dist/**/*.deb
          generate_release_notes: true
