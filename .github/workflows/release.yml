name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bin: betfair_stream_proxy
            ext: ""
            archive: tar.gz

          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            bin: betfair_stream_proxy
            ext: .exe
            archive: msi

          # Build both mac architectures using the corresponding runner architecture
          - name: macos-aarch64
            os: macos-latest
            target: aarch64-apple-darwin
            bin: betfair_stream_proxy
            ext: ""
            archive: dmg

          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
            bin: betfair_stream_proxy
            ext: ""
            archive: dmg

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Verify tag matches Cargo.toml version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CRATE_VERSION="$(cargo pkgid | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n1)"
          if [[ "${TAG_VERSION}" != "${CRATE_VERSION}" ]]; then
            echo "ERROR: tag version (${TAG_VERSION}) does not match Cargo.toml version (${CRATE_VERSION})" >&2
            exit 1
          fi

      - name: Ensure Cargo.lock is up to date
        shell: bash
        run: |
          set -euo pipefail
          cargo generate-lockfile
          git diff --exit-code -- Cargo.lock

      - name: Load app metadata
        shell: bash
        run: |
          set -euo pipefail
          source scripts/app-config.sh
          echo "APP_NAME=${APP_DISPLAY_NAME}" >> "$GITHUB_ENV"
          echo "BUNDLE_ID=${APP_BUNDLE_ID}" >> "$GITHUB_ENV"
          echo "DMG_VOLUME_NAME=${APP_DMG_VOLUME_NAME}" >> "$GITHUB_ENV"
          echo "WINDOWS_PRODUCT_NAME=${APP_WINDOWS_PRODUCT_NAME}" >> "$GITHUB_ENV"

      - name: Install Linux GUI deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev libxdo-dev

      - name: Build
        run: cargo build --release --locked --target ${{ matrix.target }} --features gui --bins

      - name: Bundle macOS .app
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME#v}" APP_BUNDLE_NAME="${APP_NAME}" BUNDLE_ID="${BUNDLE_ID}" \
            scripts/macos-bundle.sh "target/${{ matrix.target }}/release/${{ matrix.bin }}" dist

      - name: Package (tar.gz)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME#v}"
          cp "target/${{ matrix.target }}/release/${{ matrix.bin }}${{ matrix.ext }}" "dist/${{ matrix.bin }}-${{ matrix.target }}-${VERSION}${{ matrix.ext }}"
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            tar -C dist -czf "dist/${{ matrix.bin }}-${{ matrix.target }}-${VERSION}.tar.gz" \
              "${{ matrix.bin }}-${{ matrix.target }}-${VERSION}${{ matrix.ext }}" \
              "betfair_stream_proxy.app"

            # Avoid uploading the unpacked .app contents as individual artifacts.
            rm -rf "dist/betfair_stream_proxy.app"
          else
            tar -C dist -czf "dist/${{ matrix.bin }}-${{ matrix.target }}-${VERSION}.tar.gz" "${{ matrix.bin }}-${{ matrix.target }}-${VERSION}${{ matrix.ext }}"
          fi

          # Avoid uploading the raw binary in addition to the archive.
          rm -f "dist/${{ matrix.bin }}-${{ matrix.target }}-${VERSION}${{ matrix.ext }}"

      - name: Package (dmg)
        if: matrix.archive == 'dmg'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_NAME="${{ matrix.bin }}-${{ matrix.target }}-${VERSION}.dmg"
          scripts/macos-dmg.sh "dist/${APP_NAME}.app" "dist/${DMG_NAME}"

      - name: Package (msi)
        if: matrix.archive == 'msi'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $staging = Join-Path -Path $pwd -ChildPath 'dist\\msi-staging'
          New-Item -ItemType Directory -Force -Path $staging | Out-Null

          # Stage the two Rust executables.
          Copy-Item -Force -Path (Join-Path -Path 'target' -ChildPath "${{ matrix.target }}\\release\\${{ matrix.bin }}.exe") -Destination (Join-Path $staging 'betfair_stream_proxy.exe')
          Copy-Item -Force -Path (Join-Path -Path 'target' -ChildPath "${{ matrix.target }}\\release\\${{ matrix.bin }}_gui.exe") -Destination (Join-Path $staging 'betfair_stream_proxy_gui.exe')

          # Install WiX Toolset (v3) for MSI packaging.
          choco install wixtoolset -y --no-progress

          $version = "${{ github.ref_name }}".Replace('v','')
          $productVersion = "$version.0"
          $productName = "${{ env.WINDOWS_PRODUCT_NAME }}"
          $wxs = Join-Path -Path 'installer' -ChildPath 'windows\\product.wxs'
          $wixobj = Join-Path -Path 'dist' -ChildPath 'installer.wixobj'
          $msi = Join-Path -Path 'dist' -ChildPath "${{ matrix.bin }}-${{ matrix.target }}.msi"

          # Build MSI.
          & candle.exe -nologo "-dProductVersion=$productVersion" "-dProductName=$productName" "-dStagingDir=$staging" -out $wixobj $wxs
          light.exe -nologo -ext WixUIExtension -ext WixUtilExtension -out $msi $wixobj

          # Clean staging outputs.
          Remove-Item -Recurse -Force $staging
          Remove-Item -Force $wixobj

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.msi
            dist/*.cab
            dist/*.dmg

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
            dist/**/*.msi
            dist/**/*.dmg
          generate_release_notes: true
